name: üöÄ D√©ploiement Next.js sur cPanel

on:
  push:
    branches:
      - master # d√©ploie automatiquement √† chaque push sur master

jobs:
  deploy:
    name: Build & Deploy Next.js vers cPanel
    runs-on: ubuntu-latest

    steps:
      # √âtape 1 : R√©cup√©rer le code du d√©p√¥t
      - name: üì¶ Checkout du code
        uses: actions/checkout@v4

      # √âtape 2 : Configuration de Node.js
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # √âtape 3 : Installer les d√©pendances
      - name: üì• Installation des d√©pendances
        run: npm ci

      # √âtape 4 : Migration Prisma (synchronisation de la DB)
      - name: üóÑÔ∏è Ex√©cuter les migrations Prisma
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          npx prisma migrate deploy
          npx prisma generate
          echo "‚úÖ Migrations Prisma ex√©cut√©es avec succ√®s."

      # √âtape 5 : Build du projet Next.js
      - name: üõ†Ô∏è Build du projet Next.js
        env:
          NODE_ENV: production

          # ====== Base de donn√©es ======
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

          # ====== Authentification ======
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

          # ====== Providers OAuth ======
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          APPLE_CLIENT_ID: ${{ secrets.APPLE_CLIENT_ID }}
          APPLE_CLIENT_SECRET: ${{ secrets.APPLE_CLIENT_SECRET }}

          # ====== Services tiers ======
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}

          # ====== Airtel Money ======
          AIRTEL_API_BASE_URL: ${{ secrets.AIRTEL_API_BASE_URL }}
          AIRTEL_CLIENT_ID: ${{ secrets.AIRTEL_CLIENT_ID }}
          AIRTEL_CLIENT_SECRET: ${{ secrets.AIRTEL_CLIENT_SECRET }}
          AIRTEL_API_PIN: ${{ secrets.AIRTEL_API_PIN }}
          AIRTEL_MERCHANT_MSISDN: ${{ secrets.AIRTEL_MERCHANT_MSISDN }}

          # ====== Application ======
          SUPERADMIN_EMAIL: ${{ secrets.SUPERADMIN_EMAIL }}
          SUPERADMIN_PASSWORD: ${{ secrets.SUPERADMIN_PASSWORD }}
        run: npm run build

      # √âtape 6 : (Optionnel) Export statique si tu veux un site pur HTML
      - name: üì§ Export statique (optionnel)
        run: |
          if npm run | grep -q "export"; then
            npm run export
          fi

      # √âtape 7 : Pr√©parer les fichiers √† d√©ployer
      - name: üßπ Pr√©parer les fichiers pour le d√©ploiement
        run: |
          mkdir deploy
          cp -R .next public package.json next.config.ts prisma deploy/
          echo "‚úÖ Fichiers pr√©par√©s pour le d√©ploiement"

      # √âtape 8 : D√©ploiement FTP vers cPanel
      - name: üì° D√©ploiement sur cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: luxtechservices.com
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          server-dir: /public_html/
          local-dir: ./deploy
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/README.md
            **/.env*
