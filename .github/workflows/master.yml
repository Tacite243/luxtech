name: üöÄ D√©ploiement Next.js sur cPanel

on:
  push:
    branches:
      - master  # d√©ploie automatiquement √† chaque push sur master

jobs:
  deploy:
    name: Build & Deploy Next.js vers cPanel
    runs-on: ubuntu-latest

    steps:
      # √âtape 1 : R√©cup√©rer le code du d√©p√¥t
      - name: üì¶ Checkout du code
        uses: actions/checkout@v4

      # √âtape 2 : Configuration de Node.js
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # √âtape 3 : Installer les d√©pendances
      - name: üì• Installation des d√©pendances
        run: npm install

      # √âtape 4 : Build du projet
      - name: üõ†Ô∏è Build du projet Next.js
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NODE_ENV: production
        run: npm run build

      # √âtape 5 : Export statique (si applicable)
      # Si ton projet utilise next export (pas obligatoire si tu fais SSR)
      - name: üì§ Export statique (optionnel)
        run: |
          if npm run | grep -q "export"; then
            npm run export
          fi

      # √âtape 6 : Pr√©parer les fichiers √† d√©ployer
      - name: üßπ Pr√©parer les fichiers
        run: |
          mkdir deploy
          cp -R .next public package.json next.config.mjs deploy/
          cp -R node_modules deploy/node_modules || echo "node_modules non inclus"
          echo "Fichiers pr√™ts pour le d√©ploiement"

      # √âtape 7 : D√©ploiement FTP vers cPanel
      - name: üì° D√©ploiement sur cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: luxtechservices.com
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          server-dir: /public_html/ # le r√©pertoire distant (√† adapter)
          local-dir: ./deploy
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/README.md
            **/.env*
